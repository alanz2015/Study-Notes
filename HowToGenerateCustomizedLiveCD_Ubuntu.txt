How to customize Ubuntu version Linux kernel
============================================
Reference:
    * https://askubuntu.com/questions/163298/whats-a-simple-way-to-recompile-the-kernel/830723#830723
    * Building Kernel DEB packages: http://r.outlyer.net/debian:kerneldeb

1. Use apt-get source to download the Ubuntu version of the kernel

apt-get source linux-image-$(uname -r)

gives a folder that contains, for example:

linux-3.2.0                linux_3.2.0-26.41.dsc
linux_3.2.0-26.41.diff.gz  linux_3.2.0.orig.tar.gz

The bolded diff includes all the Ubuntu/Debian customizations.
2. To build a stock kernel with your own .config, use the "old-fashioned" Debian make-kpkg method

This is the alternate old-fashioned way described in the wiki:

sudo apt-get install kernel-package

If you are compiling a kernel for the first time:

sudo apt-get build-dep linux-image-$(uname -r)

Then cd into the source directory (here, linux-3.2.0), and either run make oldconfig to create .config file with your running kernel's configuration, or copy a third-part .config to this directory.

Depending on whether you want a text or graphical config, install:
sudo apt-get install libncurses5 libncurses5-dev

make clean
make mrproper
make menuconfig

#Install necessary things
apt-get update
apt-get install kernel-package libncurses5-dev fakeroot wget bzip2 build-essential -y
fakeroot make-kpkg -j N --initrd --append-to-version=my-very-own-kernel kernel-image kernel-headers

Trouble Shooting:
~~~~~~~~~~~~~~~~~
Sometimes when encounter dpkg-gencontrol failure for '_' char, can fix as following:
make menuconfig -> General setup -> Local version - append to kernel release

Add kernel commandline parameters:
+CONFIG_CMDLINE="foo=1"
+CONFIG_CMDLINE_EXTEND=y

Check runtime:-
$cat /proc/cmdline

that is CONFIG_LOCALVERSION in the .config file.
https://debian-handbook.info/browse/squeeze/sect.kernel-compilation.html
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

where N is how many jobs to run in parallel (usually the number of CPUs you have), and my-very-own-kernel is a custom string to identify this build.

When done, the kernel image and header files will be ready as debs in the parent directory; you can install them with sudo dpkg -i, which will also take care of adding GRUB entries, etc.


Live CD Customization From Scratch
==================================
https://help.ubuntu.com/community/LiveCDCustomizationFromScratch

Step 1: 
sudo apt-get install debootstrap

# alternatively, download the package and run sudo dpkg -i debootstrap_$VERSION.deb

mkdir -p work/chroot

cd work

sudo debootstrap --arch=amd64 xenial|trusty|... chroot 

Step 2:
sudo mount --bind /dev chroot/dev
sudo cp /etc/hosts chroot/etc/hosts
sudo cp /etc/resolv.conf chroot/etc/resolv.conf
sudo cp /etc/apt/sources.list chroot/etc/apt/sources.list
Note: If you are bootstrapping a release of Ubuntu other then the release you are currently running you should substitute the 'sudo cp /etc/apt/sources.list chroot/etc/apt/sources.list' command with the following.


sudo sed s/<Release-You-Are-On>/<Release-You-Are-Bootstrapping>/ < /etc/apt/sources.list > chroot/etc/apt/sources.list

Step 3:
sudo chroot chroot

mount none -t proc /proc
mount none -t sysfs /sys
mount none -t devpts /dev/pts
export HOME=/root
export LC_ALL=C
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 12345678  #Substitute "12345678" with the PPA's OpenPGP ID.
apt-get update  // Need to specify proxy here
apt-get install --yes dbus
dbus-uuidgen > /var/lib/dbus/machine-id
dpkg-divert --local --rename --add /sbin/initctl

NOTE: If remove everything, you need to do "umount" one by one.

Step 4:
Upgrade packages if you want: 


apt-get --yes upgrade
Install packages needed for Live System:

apt-get install --yes ubuntu-standard casper lupin-casper
apt-get install --yes discover laptop-detect os-prober
apt-get install --yes linux-generic 

apt-get install fakeroot build-essential devscripts
apt-get install crash kexec-tools makedumpfile kernel-wedge
apt-get build-dep linux-image-$(uname -r)
apt-get install git libncurses5 libncurses5-dev libnewt-dev

Step 5:
To retrieve specifid kernel release bundled with Ubuntu release (xenial), to do
sudo git clone git://kernel.ubuntu.com/ubuntu/ubuntu-xenial.git

inside the "git clone" directory, you can see there exist ubuntu-flavor scripts.

Step 6:
root@alanzelite-VirtualBox:/ubuntu-xenial# head -5 Makefile
VERSION = 4
PATCHLEVEL = 4
SUBLEVEL = 59
EXTRAVERSION =
NAME = Blurry Fish Butt
root@alanzelite-VirtualBox:/ubuntu-xenial# git rm debian.master/changelog

DEBEMAIL="zhangx2000@hotmail.com"; DEBFULLNAME="Alan Zhang"; dch -v 4.4.59-999.201705081943 --distribution xenial --package linux --create -c debian.master/changelog Mainline build: v4.4.59

Modify check files
During modification of configuration files and during the compilation process, Ubuntu does some checks to see if it all looks good but as we are not compiling a kernel with Ubuntu patches these checks might fail. Therefor we will be modifying these files and instead of doing it manually weâ€™ll use a small script to accomplish the needed changes.

for i in debian/scripts/*-check debian.master/scripts/*-check
do
    if [ -f "$i" ]; then
        cat - <<eom>"$i"
#!/bin/sh
exit 0
EOM
        chmod 755 "$i"
    fi
done
</eom>

git commit -a -m "Our own kernel"

Step 7:
Create a new config

Step 8:
cd ../linux-4.14.89/
ls -al
git status
make menuconfig
perl -pi -e 's/.*CONFIG_LOCALVERSION=.*/CONFIG_LOCALVERSION=".alanz.0"/' .config
make olddefconfig
make -j8 bindeb-pkg     # Inside Ubuntu kernel build env, use command "fakeroot debian/rules binary-debs flavours=generic" instead

Another thread to Upgrade kernel w/ current usage kernel config file when encounter boot
failure phenomena:

* cp /boot/config-* kernel/arch/x86/configs/test4spurv_defconfig
* ./scripts/kconfig/merge_config.sh arch/x86/configs/test4spurv_defconfig /YourAndroidAlternative/kernel.config
* perl -pi -e 's/.*CONFIG_LOCALVERSION=.*/CONFIG_LOCALVERSION=".alanz20190506.0"/' .config
* make olddefconfig
* make -j8 bindeb-pkg

Step 9:
sudo dpkg -i ../*.deb

Quotation:
~~~~~~~~~~
https://wiki.ubuntu.com/Kernel/BuildYourOwnKernel
https://help.ubuntu.com/community/Kernel/Compile
https://help.ubuntu.com/community/LiveCDCustomizationFromScratch
https://wiki.ubuntu.com/KernelTeam/GitKernelBuild
https://wiki.ubuntu.com/Kernel/MainlineBuilds
https://wiki.archlinux.org/index.php/kernel_parameters
https://www.linuxquestions.org/questions/debian-26/how-to-install-debian-using-debootstrap-4175465295/
https://unix.stackexchange.com/questions/275429/creating-bootable-debian-image-with-debootstrap


How to enable Audio Enabling on Z8350 + Linux kernel 4.14.89
============================================================
Source: 
https://askubuntu.com/questions/1004998/ubuntu-17-10-cherry-trail-problem-with-sound-funny-and-sad
https://patchwork.kernel.org/patch/9212963/
https://docs.google.com/document/d/1AcXZI9dvJBW0Vy6h9vraD7VP9X_MpwHx0eJ6hNc4G_s/edit

æ˜¾ç¤ºæ¨¡å—ä¿¡æ¯ï¼š
$ modinfo module_name
æ˜¾ç¤ºæ‰€æœ‰æ¨¡å—çš„é…ç½®ä¿¡æ¯ï¼š
$ modprobe -c | less
æ˜¾ç¤ºæŸä¸ªæ¨¡å—çš„é…ç½®ä¿¡æ¯ï¼š
$ modprobe -c | grep module_name
æ˜¾ç¤ºä¸€ä¸ªè£…å…¥æ¨¡å—ä½¿ç”¨çš„é€‰é¡¹ï¼š
$ systool -v -m module_name
æ˜¾ç¤ºæ¨¡å—çš„ä¾èµ–å…³ç³»ï¼š
$ modprobe --show-depends module_name


in etc/modprobe.d create file blacklist_hdmi.conf with contents:

blacklist snd_hdmi_lpe_audio
download and run this linixium sh script:

https://drive.google.com/file/d/0B99O3A0dDe67VUNMV2xfVjJKeVk/edit

in /usr/share/alsa/ucm/ create a bytcr-rt5651 folder with contents:

asound.state

bytcr-rt5651.conf

HiFi.conf

sudo alsa force-reload

rm -r ~/.pulse ~/.asound* ~/.pulse-cookie ~/.config/pulse
pulseaudio -k
reboot
open pavucontrol and set configuration profile to HiFi and change output from headphones to speakers.

Bash script sample file:
========================
#!/bin/bash

sudo apt-get update
sudo apt-get upgrade
sudo dpkg -i ~/workspace/*.deb
sudo echo "blacklist snd_hdmi_lpe_audio" >> /etc/modprobe.d/blacklist_hdmi.conf
sudo -E ./linuxium-install-UCM-files.sh

sudo alsa force-reload
rm -r ~/.pulse ~/.asound* ~/.pulse-chttps://0xax.gitbooks.io/linux-insides/content/Booting/ookie ~/.config/pulse
pulseaudio -k

sudo cp ./brcmfmac43455-sdio.txt /lib/firmware/brcm/brcmfmac43455-sdio.txt

sudo reboot

---- End of File ----

Enabling ES8316
---------------
Reference:
https://bugzilla.kernel.org/show_bug.cgi?id=189261

/sound/soc/codecs/es8316.c  : Codec driver. Should occur /sys/bus/acpi/devices/ESSX
/sound/soc/codecs/es8316.h
/sound/soc/codecs/Makefile
/sound/soc/codecs/Kconfig
/sound/soc/intel/Kconfig
/sound/soc/intel/boards/cht_bsw_es8316.c | bytcht_es8316.c  : stands for Machine Driver that define DAI name i2c-ESSX8316:00.
/sound/soc/intel/boards/Makefile
/sound/soc/intel/sst/atom/sst_acpi.c    : Associated with /sys/bus/acpi/devices/808622AB:00/, enable SST module, also involve 'intel_sst_acpi 808622A8:00: Direct firmware load for intel/fw_sst_22a8.bin

Enabling AP6255 Bluetooth on Z8350
----------------------------------
Reference:
https://lists.ubuntu.com/archives/kernel-team/2018-May/092134.html

Set up Ubuntu VPN Guide
-----------------------
https://intelpedia.intel.com/VpnQuickStart
https://wiki.ith.intel.com/display/CTSNMPDBG/Intel+VPN+on+Ubuntu+Linux

Build kernel for Android
------------------------
export CROSS_COMPILE=$(pwd)/bin/aarch64-linux-android-
export ARCH=arm64 && export SUBARCH=arm64 

mkdir -p out
make O=out clean
make O=out mrproper
make O=out <defconfig_name>
make O=out -j$(nproc ¨Call)

Reference Book: https://0xax.gitbooks.io/linux-insides/content/Booting/

